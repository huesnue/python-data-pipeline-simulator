name: tests

on:
  push:
    branches: [ "main" ]
  pull_request:

jobs:
  run-tests-and-generate-badge:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          pip install -r requirements.txt
          pip install coverage

      - name: Run tests with coverage
        run: |
          coverage run -m pytest
          coverage xml

      - name: Generate coverage badge
        run: |
          python3 - << 'EOF'
          import xml.etree.ElementTree as ET

          tree = ET.parse('coverage.xml')
          root = tree.getroot()
          line_rate = float(root.get('line-rate', 0))
          percent = int(line_rate * 100)

          svg = f'''
          <svg xmlns="http://www.w3.org/2000/svg" width="120" height="20">
            <linearGradient id="b" x2="0" y2="100%">
              <stop offset="0" stop-color="#bbb" stop-opacity=".1"/>
              <stop offset="1" stop-opacity=".1"/>
            </linearGradient>
            <mask id="a">
              <rect width="120" height="20" rx="3" fill="#fff"/>
            </mask>
            <g mask="url(#a)">
              <rect width="60" height="20" fill="#555"/>
              <rect x="60" width="60" height="20" fill="#4c1"/>
              <rect width="120" height="20" fill="url(#b)"/>
            </g>
            <g fill="#fff" text-anchor="middle"
               font-family="DejaVu Sans,Verdana,Geneva,sans-serif" font-size="11">
              <text x="30" y="14">coverage</text>
              <text x="90" y="14">{percent}%</text>
            </g>
          </svg>
          '''

          with open("coverage-badge.svg", "w") as f:
              f.write(svg)
          EOF

      - name: Commit coverage badge
        run: |
          git config user.name "github-actions"
          git config user.email "github-actions@github.com"
          git add coverage-badge.svg
          git commit -m "Update coverage badge" || echo "No changes to commit"
          git push
